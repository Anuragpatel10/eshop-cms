@{sitemap('shopping-cart')}

@{view('~/menutop')}

<div id="loading"></div>
<div class="main">
    <div class="container">
        <ul class="breadcrumb">
            @{foreach m in sitemap()}
            @{if m.id === 'category'}
            @{sitemap_category(m.url, repository.category)}
            @{else}
            @{if m.last}
            <li class="active">@{m.name}</li>
            @{else}
            <li><a href="@{m.url}">@{m.name}</a></li>
            @{fi}
            @{fi}
            @{end}
        </ul>


        <!-- BEGIN SIDEBAR & CONTENT -->
        <div class="row margin-bottom-40 ">
            <!-- BEGIN CONTENT -->
            <div class="col-md-12 col-sm-12">
                <h1>@{title}</h1>
                <div class="row">
                    <div class="col-md-1"></div>
                    <div class="col-md-10">
                        <table class="table table-bordered checkoutlist" border="0">
                            <thead class="hidden-xs">
                                <tr>
                                    <th class="ui-center">@(Item name)</th>
                                    <th class="ui-center hidden-xs">@(Price)</th>
                                    <th class="ui-center">@(Count)</th>
                                    <th class="ui-center">@(Total)</th>
                                </tr>
                            </thead>
                            <tbody data-component="repeater" data-component-path="datasource">
                            <script type="text/html">
                                <tr>
                                    <td><a href="{{ linker }}">{{ name }}</a><div class="visible-xs fs11 mt10">@(One piece:) @{currency('{{ price | format(2) }}')}</div></td>
                                    <td class="ui-right col-xs-2">@{currency('{{ price | format(2) }}')}</td>
                                    <td class="ui-right col-xs-2 col-sm-1 active"><input type="text" value="{{ count }}" data-id="{{ id }}" maxlength="2" /></td>
                                    <td class="ui-right col-xs-3 col-sm-2 b warning"><span class="visible-xs checkoutlist-label">@(Together:)</span><span class="checkoutlist-item-price" data-format="@{currency('{0}')}">@{currency('{{ price | sum(2) }}')}</span><span class="fa fa-times-circle hidden-xs" data-id="{{ id }}"></span></td>
                                </tr>
                            </script>
                            </tbody>
                            <tfoot data-component="template" data-component-path="summarize" class="hidden-xs">
                            <script type="text/html">
                                <tr class="active">
                                    <td class="b black">@(Summarize)</td>
                                    <td class="col-xs-2"></td>
                                    <td class="ui-center col-xs-2 col-sm-1 b black">{{ count }}x</td>
                                    <td class="ui-right col-xs-3 col-sm-2 b black">@{currency('{{ price | format(2) }}')}<span class="fa fa-calculator hidden-xs"></span></td>
                                </tr>
                            </script>
                            </tfoot>
                        </table>
                    </div>
                </div>



                <div data-component="visible" data-component-path="datasource" data-if="!value || !value.length" class="hidden">
                    <div class="shopping-cart-page">
                        <div class="shopping-cart-data clearfix">
                            <p>@(Your shopping cart is empty, <b>try to visit this page later</b>.)</p>
                            <a href="@{sitemap_url('products')}" class="linkbutton"><span class="fa fa-search"></span> @(Browse all products)</a>
                        </div>
                    </div>
                </div>


                <div data-component="visible" data-component-path="datasource" data-if="value && value.length > 0" class="hidden">
                    <div class="goods-page">
                        <div class="goods-data clearfix">
                            <div class="table-wrapper-responsive">
                                <table summary="Shopping cart">
                                    <tr>
                                        <th class="goods-page-image">Image</th>
                                        <th class="goods-page-description">Description</th>
                                        <th class="goods-page-ref-no">Ref No</th>
                                        <th class="goods-page-quantity">Quantity</th>
                                        <th class="goods-page-price">Unit price</th>
                                        <th class="goods-page-total" colspan="2">Total</th>
                                    </tr>
                                    <tr>
                                        <td class="goods-page-image">
                                            <a href="javascript:;"><img src="/assets/pages/img/products/model3.jpg" alt="Berry Lace Dress"></a>
                                        </td>
                                        <td class="goods-page-description">
                                            <h3><a href="javascript:;">Cool green dress with red bell</a></h3>
                                            <p><strong>Item 1</strong> - Color: Green; Size: S</p>
                                            <em>More info is here</em>
                                        </td>
                                        <td class="goods-page-ref-no">
                                            javc2133
                                        </td>
                                        <td class="goods-page-quantity">
                                            <div class="product-quantity">
                                                <input id="product-quantity" type="text" value="1" readonly class="form-control input-sm">
                                            </div>
                                        </td>
                                        <td class="goods-page-price">
                                            <strong><span>$</span>47.00</strong>
                                        </td>
                                        <td class="goods-page-total">
                                            <strong><span>$</span>47.00</strong>
                                        </td>
                                        <td class="del-goods-col">
                                            <a class="del-goods" href="javascript:;">&nbsp;</a>
                                        </td>
                                    </tr>
                                    <tr>
                                        <td class="goods-page-image">
                                            <a href="javascript:;"><img src="/assets/pages/img/products/model4.jpg" alt="Berry Lace Dress"></a>
                                        </td>
                                        <td class="goods-page-description">
                                            <h3><a href="javascript:;">Cool green dress with red bell</a></h3>
                                            <p><strong>Item 1</strong> - Color: Green; Size: S</p>
                                            <em>More info is here</em>
                                        </td>
                                        <td class="goods-page-ref-no">
                                            javc2133
                                        </td>
                                        <td class="goods-page-quantity">
                                            <div class="product-quantity">
                                                <input id="product-quantity2" type="text" value="1" readonly class="form-control input-sm">
                                            </div>
                                        </td>
                                        <td class="goods-page-price">
                                            <strong><span>$</span>47.00</strong>
                                        </td>
                                        <td class="goods-page-total">
                                            <strong><span>$</span>47.00</strong>
                                        </td>
                                        <td class="del-goods-col">
                                            <a class="del-goods" href="javascript:;">&nbsp;</a>
                                        </td>
                                    </tr>
                                </table>
                            </div>

                            <div class="shopping-total">
                                <ul>
                                    <li>
                                        <em>Sub total</em>
                                        <strong class="price"><span>$</span>47.00</strong>
                                    </li>
                                    <li>
                                        <em>Shipping cost</em>
                                        <strong class="price"><span>$</span>3.00</strong>
                                    </li>
                                    <li class="shopping-total-price">
                                        <em>Total</em>
                                        <strong class="price"><span>$</span>50.00</strong>
                                    </li>
                                </ul>
                            </div>
                        </div>
                        <button class="btn btn-default" type="submit">Continue shopping <i class="fa fa-shopping-cart"></i></button>
                        <button class="btn btn-primary" type="submit">Checkout <i class="fa fa-check"></i></button>
                    </div>
                </div>
            </div>
            <!-- END CONTENT -->
        </div>
    </div>
</div>

<!-- Stores the current user data (JSON) -->
@{json(user, 'userprofile')}

@{section script}
<script>

    var common = {};
    var form = {};
    var datasource;

    // Reads delivery types from the eshop configuration
    SET('common.deliverytypes', '@{config.custom.deliverytypes.join(",")}'.split(','));

    form.email = '@';
    form.address = '';
    form.isnewsletter = true;

    var userprofile = JSON.parse($('#userprofile').html());
    if (userprofile) {
        form.firstname = userprofile.firstname;
        form.lastname = userprofile.lastname;
        form.email = userprofile.email;
    }

    jC.ready(function () {

        var cart = CACHE('cart');
        if (!cart)
            return;

        var id = [];

        for (var i = 0, length = cart.length; i < length; i++)
            id.push(cart[i].id);

        AJAX('GET /api/products/', {id: id.join(',')}, function (response) {

            datasource = [];

            for (var i = 0, length = response.items.length; i < length; i++) {
                var item = response.items[i];
                datasource.push({id: item.id, name: item.name, price: item.price, linker: item.linker, linker_category: item.linker_category, pictures: item.pictures, reference: item.reference});
            }

            if (!datasource.length)
                FIND('checkout').clear();

            refresh(true);
        });

        $('.checkoutlist').on('change', 'input', function (e) {
            var count = parseInt(this.value.match(/\d+/));
            if (isNaN(count))
                return;

            var id = this.getAttribute('data-id');
            var checkout = FIND('checkout');
            var output = checkout.update(id, count);

            if (!output) {
                var el = $(this).closest('tr').find('.checkoutlist-item-price');
                var item = checkout.get(id);
                el.html(el.attr('data-format').format(Tangular.helpers.sum.call(item, item.price, 2)));
            }

            refresh(output === 1);
        });

        $('.checkoutlist').on('click', '.fa-times-circle', function (e) {
            var output = FIND('checkout').update($(this).attr('data-id'), 0);
            refresh(output === 1);
        });
    });

    Tangular.register('sum', function (value, format) {
        return (value * this.count).format(format);
    });

    function refresh(redraw) {
        var cart = CACHE('cart');
        var index = 0;
        while (true) {

            var product = datasource[index++];
            if (product === undefined)
                break;

            var item = cart.findItem('id', product.id);

            if (!item) {
                index--;
                datasource.splice(index, 1);
                continue;
            }

            product.count = item.count;
        }

        var count = 0;
        var price = 0;
        for (var i = 0, length = datasource.length; i < length; i++) {
            var product = datasource[i];
            price += product.price * product.count;
            count += product.count;
        }

        if (redraw)
            UPDATE('datasource');
        SET('summarize', {count: count, price: price});
    }

    OPERATION('submit', function () {
        if (BLOCKED('submit', 3000))
            return;

        form.products = datasource;

        RESET('form.*');
        loading(true);

        AJAX('POST /api/checkout/create/', form, function (response) {
            loading(false, 1000);

            if (!response.success) {
                SET('common.success', response);
                return;
            }

            FIND('checkout').clear();
            location.href = jRouting.path(location.pathname) + response.value + '/?success=1';
        });
    });

</script>
@{end}

@{view('~/footers')}