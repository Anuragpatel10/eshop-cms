@{view('~/menutop0')}

<!-- BEGIN HEADER -->
<div class="header">
    <div class="container">
        <a class="site-logo" href="/"><img src="/img/logo.png" alt="Eshop" height="40"></a>

        <a href="javascript:void(0);" class="mobi-toggler"><i class="fa fa-bars"></i></a>

        <!-- BEGIN CART -->
        <div class="top-cart-block">
            <div class="top-cart-info" data-component="checkout">
                <a href="@{sitemap_url('shopping-cart')}" class="top-cart-info-count count" >0 items</a>
                <a href="@{sitemap_url('shopping-cart')}" class="top-cart-info-value total" data-currency="@{config.custom.currency_entity}">&nbsp;</a>
            </div>
            <i class="fa fa-shopping-cart"></i>

            <div class="top-cart-content-wrapper">
                <div class="top-cart-content checkoutlist">
                    <ul class="scroller" style="height: 250px;" data-component="repeater" data-component-path="datasource">
                        <script type="text/html">
                            <li>
                                <a href="{{ linker }}"><img src="/images/small/{{pictures[0]}}.jpg" alt="{{ name }}" width="37" height="34"></a>
                                <span class="cart-content-count">x {{ count }}</span>
                                <strong><a href="{{ linker }}">{{ name }}</a></strong>
                                <em>@{currency('{{ price | format(2) }}')}</em>
                                <a class="del-goods" data-id="{{ id }}">&nbsp;</a>
                            </li>
                            </script>
                        </ul>
                        <div class="text-right">
                            <a href="@{sitemap_url('shopping-cart')}" class="btn btn-default">@(View Cart)</a>
                            <a href="@{sitemap_url('checkout')}" class="btn btn-primary">@(Checkout)</a>
                        </div>
                    </div>
                </div>            
            </div>
            <!--END CART -->

            <div class="col-md-8 padding-top-30">
                <form action="@{sitemap_url('products')}" method="GET">
                    <div class="input-group search">
                        <input placeholder="@(Search items ...)" value="@{query.q}" autofocus="autofocus" class="form-control" type="text" name="q">
                        <span class="input-group-btn">
                            <button class="btn btn-primary" type="submit">Search</button>
                        </span>
                    </div>
                </form>
            </div>
            <!-- END NAVIGATION -->
        </div>
    </div>
    <!-- Header END -->

    <!-- Stores the current user data (JSON) -->
    @{json(user, 'userprofile')}

    @{section script}
    <script>

        var common = {};
        var form = {};
        var datasource;

        // Reads delivery types from the eshop configuration
        SET('common.deliverytypes', '@{config.custom.deliverytypes.join(",")}'.split(','));

        form.email = '@';
        form.address = '';
        form.isnewsletter = true;

        var userprofile = JSON.parse($('#userprofile').html());
        if (userprofile) {
            form.firstname = userprofile.firstname;
            form.lastname = userprofile.lastname;
            form.email = userprofile.email;
        }

        jC.ready(function () {

            var cart = CACHE('cart');
            if (!cart)
                return;

            var id = [];

            for (var i = 0, length = cart.length; i < length; i++)
                id.push(cart[i].id);

            AJAX('GET /api/products/', {id: id.join(',')}, function (response) {

                datasource = [];

                for (var i = 0, length = response.items.length; i < length; i++) {
                    var item = response.items[i];
                    datasource.push({id: item.id, name: item.name, price: item.price, linker: item.linker, linker_category: item.linker_category, pictures: item.pictures, reference: item.reference});
                }

                if (!datasource.length)
                    FIND('checkout').clear();

                refresh(true);
            });



            $('.checkoutlist').on('click', '.btn', function (e) {
                //console.log($(this).hasClass("quantity-down"));
                //return console.log(this);
                var count = parseInt($(this).closest('tr').find('#product-quantity').val());
                if (isNaN(count))
                    return;

                if ($(this).hasClass("quantity-down") && count > 0)
                    count--;
                else if ($(this).hasClass("quantity-up"))
                    count++;

                var id = this.getAttribute('data-id');
                var checkout = FIND('checkout');
                var output = checkout.update(id, count);

                if (!output) {
                    var el = $(this).closest('tr').find('.checkoutlist-item-price');
                    var item = checkout.get(id);
                    el.html(el.attr('data-format').format(Tangular.helpers.sum.call(item, item.price, 2)));

                    var el = $(this).closest('tr').find('#product-quantity');
                    el.val(count);
                }

                refresh(output === 1);
            });

            $('.checkoutlist').on('click', '.del-goods', function (e) {
                var output = FIND('checkout').update($(this).attr('data-id'), 0);
                var target = $('.detail-checkout');
                if (target)
                    target.addClass('hidden');
                refresh(output === 1);
                //location.reload();
                //reloadDataProduct();
            });
        });

        Tangular.register('sum', function (value, format) {
            return (value * this.count).format(format);
        });

        function refresh(redraw) {

            var cart = CACHE('cart');

            if (!cart)
                return;

            var id = [];

            for (var i = 0, length = cart.length; i < length; i++)
                id.push(cart[i].id);

            AJAX('GET /api/products/', {id: id.join(',')}, function (response) {

                datasource = [];

                for (var i = 0, length = response.items.length; i < length; i++) {
                    var item = response.items[i];
                    datasource.push({id: item.id, name: item.name, price: item.price, linker: item.linker, linker_category: item.linker_category, pictures: item.pictures, reference: item.reference});
                }

                if (!datasource.length)
                    FIND('checkout').clear();

                //refresh(true);




                var index = 0;
                while (true) {

                    var product = datasource[index++];
                    if (product === undefined)
                        break;

                    var item = cart.findItem('id', product.id);

                    if (!item) {
                        index--;
                        datasource.splice(index, 1);
                        continue;
                    }

                    product.count = item.count;
                }

                var count = 0;
                var price = 0;
                for (var i = 0, length = datasource.length; i < length; i++) {
                    var product = datasource[i];
                    price += product.price * product.count;
                    count += product.count;
                }

                if (redraw)
                    UPDATE('datasource');
                SET('summarize', {count: count, price: price});
            });
        }

        OPERATION('submit', function () {
            if (BLOCKED('submit', 3000))
                return;

            form.products = datasource;

            RESET('form.*');
            loading(true);

            AJAX('POST /api/checkout/create/', form, function (response) {
                loading(false, 1000);

                if (!response.success) {
                    SET('common.success', response);
                    return;
                }

                FIND('checkout').clear();
                location.href = jRouting.path(location.pathname) + response.value + '/?success=1';
            });
        });

    </script>
    @{end}